name: NPM Update Bot ðŸ¤–

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: false
        type: boolean
  # schedule:
  #   - cron: "0 0 * * 1"

jobs:
  npmupbot:
    name: NPM Update Bot ðŸ¤–
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          check-latest: true
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            src/package-lock.json

      - name: Bot ðŸ¤– "Updating NPM Packages..."
        run: |
          npm install -g --silent npm-check-updates
          
          # Check for updates in root package.json
          echo "Checking root package.json..."
          ncu -u || echo "No updates in root package.json"
          npm update || echo "No updates to install in root"
          
          # Check for updates in src/package.json
          echo "Checking src/package.json..."
          cd src
          ncu -u || echo "No updates in src/package.json"
          npm update || echo "No updates to install in src"
          cd ..
          
          # Run buildcss from src directory if script exists
          echo "Building CSS..."
          cd src
          if npm run --silent buildcss 2>/dev/null; then
            npm run buildcss || echo "CSS build failed, continuing..."
          else
            echo "buildcss script not found, skipping..."
          fi
          cd ..
          
          # Check if there are changes or if force update is requested
          if git diff --quiet && [ "${{ github.event.inputs.force_update }}" != "true" ]; then
            echo "No changes to commit"
            echo "Manual run: ${{ github.event_name == 'workflow_dispatch' }}"
            echo "Force update: ${{ github.event.inputs.force_update }}"
          else
            echo "Changes detected or force update requested"
            git config --global user.name 'NPM Update Bot'
            git config --global user.email 'npmupbot@users.noreply.github.com'
            git add .
            git commit -am "npm: package updates (manual: ${{ github.event_name == 'workflow_dispatch' }})" || echo "No changes to commit"
            git push || echo "Push failed, may need manual intervention"
          fi
